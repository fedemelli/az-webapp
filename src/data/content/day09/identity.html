<h2>Autenticazione per Azure Files</h2>
<p>Azure Files supporta diversi metodi di autenticazione, dall'accesso semplice tramite chiavi a metodi identity-based
  che permettono permessi granulari NTFS.</p>

<svg viewBox="0 0 600 300" style="width:100%;max-width:600px;margin:20px auto;display:block;">
  <!-- Storage Account Key -->
  <rect x="20" y="20" width="130" height="120" rx="8" fill="#fef2f2" stroke="#ef4444" stroke-width="2" />
  <text x="85" y="50" text-anchor="middle" font-weight="bold" fill="#dc2626" font-size="11">Storage Key</text>
  <text x="85" y="75" text-anchor="middle" fill="#64748b" font-size="10">Accesso totale</text>
  <text x="85" y="95" text-anchor="middle" fill="#64748b" font-size="10">Super-user</text>
  <text x="85" y="120" text-anchor="middle" fill="#ef4444" font-size="9">Meno sicuro</text>

  <!-- Azure AD DS -->
  <rect x="160" y="20" width="130" height="120" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="2" />
  <text x="225" y="50" text-anchor="middle" font-weight="bold" fill="#2563eb" font-size="11">Azure AD DS</text>
  <text x="225" y="75" text-anchor="middle" fill="#64748b" font-size="10">VM in Azure</text>
  <text x="225" y="95" text-anchor="middle" fill="#64748b" font-size="10">Domain joined</text>
  <text x="225" y="120" text-anchor="middle" fill="#3b82f6" font-size="9">Cloud-only</text>

  <!-- On-prem AD DS -->
  <rect x="300" y="20" width="130" height="120" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2" />
  <text x="365" y="50" text-anchor="middle" font-weight="bold" fill="#16a34a" font-size="11">On-prem AD</text>
  <text x="365" y="75" text-anchor="middle" fill="#64748b" font-size="10">Hybrid identity</text>
  <text x="365" y="95" text-anchor="middle" fill="#64748b" font-size="10">Azure AD Connect</text>
  <text x="365" y="120" text-anchor="middle" fill="#22c55e" font-size="9">Enterprise</text>

  <!-- Azure AD Kerberos -->
  <rect x="440" y="20" width="130" height="120" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2" />
  <text x="505" y="50" text-anchor="middle" font-weight="bold" fill="#d97706" font-size="11">Entra Kerberos</text>
  <text x="505" y="75" text-anchor="middle" fill="#64748b" font-size="10">Hybrid joined</text>
  <text x="505" y="95" text-anchor="middle" fill="#64748b" font-size="10">Entra joined</text>
  <text x="505" y="120" text-anchor="middle" fill="#f59e0b" font-size="9">Modern</text>

  <!-- Permission levels -->
  <rect x="20" y="170" width="550" height="110" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" />
  <text x="295" y="195" text-anchor="middle" font-weight="bold" fill="#334155" font-size="12">Due Livelli di
    Permessi</text>

  <rect x="40" y="210" width="240" height="55" rx="6" fill="#dbeafe" />
  <text x="160" y="235" text-anchor="middle" font-weight="bold" fill="#1e40af" font-size="11">Share-level (RBAC)</text>
  <text x="160" y="252" text-anchor="middle" fill="#3b82f6" font-size="10">Reader, Contributor, Elevated
    Contributor</text>

  <rect x="310" y="210" width="240" height="55" rx="6" fill="#dcfce7" />
  <text x="430" y="235" text-anchor="middle" font-weight="bold" fill="#166534" font-size="11">File/Folder (NTFS)</text>
  <text x="430" y="252" text-anchor="middle" fill="#22c55e" font-size="10">Read, Write, Execute, Full Control</text>
</svg>

<h3>Opzioni di Autenticazione</h3>
<table style="width:100%;border-collapse:collapse;margin:16px 0;">
  <thead>
    <tr style="background:#f1f5f9;">
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Metodo</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Requisiti</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Caso d'Uso</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;"><strong>Storage Account Key</strong></td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Chiave dello storage account</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Accesso amministrativo, script, mount rapidi</td>
    </tr>
    <tr style="background:#f8fafc;">
      <td style="padding:12px;border:1px solid #e2e8f0;"><strong>Azure AD Domain Services</strong></td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Azure AD DS, VM domain-joined</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Ambienti cloud-only senza AD on-prem</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;"><strong>On-premises AD DS</strong></td>
      <td style="padding:12px;border:1px solid #e2e8f0;">AD on-prem + Azure AD Connect sync</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Hybrid enterprise, identit√† esistenti</td>
    </tr>
    <tr style="background:#f8fafc;">
      <td style="padding:12px;border:1px solid #e2e8f0;"><strong>Microsoft Entra Kerberos</strong></td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Entra joined o hybrid joined devices</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Accesso da client moderni senza VPN</td>
    </tr>
  </tbody>
</table>

<h3>Due Livelli di Permessi</h3>
<p>Con identity-based authentication, i permessi sono applicati su due livelli:</p>

<h4>1. Share-level Permissions (RBAC)</h4>
<p>Ruoli Azure assegnati a utenti/gruppi per l'accesso alla share:</p>
<ul>
  <li><strong>Storage File Data SMB Share Reader</strong>: lettura di file e cartelle</li>
  <li><strong>Storage File Data SMB Share Contributor</strong>: lettura, scrittura, eliminazione</li>
  <li><strong>Storage File Data SMB Share Elevated Contributor</strong>: come Contributor + modifica NTFS ACL</li>
</ul>

<h4>2. NTFS Permissions (Directory/File Level)</h4>
<p>Permessi Windows standard configurabili dopo il mount:</p>
<pre><code># Windows - Configurare NTFS permissions (con Elevated Contributor)
icacls Z:\\ /grant "DOMAIN\\User:(M)"
icacls Z:\\folder /grant "DOMAIN\\Group:(OI)(CI)F"</code></pre>

<h3>Configurazione Identity-based Auth</h3>
<pre><code># Abilitare Azure AD DS authentication
az storage account update \\
  --name mystorageaccount \\
  --resource-group myResourceGroup \\
  --enable-files-aadds true

# Verificare lo stato
az storage account show \\
  --name mystorageaccount \\
  --resource-group myResourceGroup \\
  --query "azureFilesIdentityBasedAuthentication"</code></pre>

<h3>Best Practices</h3>
<ul>
  <li><strong>Evita storage key</strong> per accesso utente; usalo solo per script e admin</li>
  <li>Usa <strong>gruppi Azure AD</strong> per assegnare share-level permissions</li>
  <li>Configura NTFS permissions tramite un <strong>super-user</strong> con Elevated Contributor</li>
  <li>Per accesso esterno, considera <strong>Private Endpoint</strong> + VPN</li>
</ul>

<!-- Callout esame -->
<div
  style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-left:4px solid #3b82f6;border-radius:12px;padding:20px;margin-top:24px;">
  <div style="display:flex;align-items:flex-start;gap:12px;">
    <span style="font-size:24px;">üìù</span>
    <div>
      <strong style="color:#1e40af;font-size:15px;">Tips per l'Esame AZ-104</strong>
      <ul style="margin:8px 0 0 0;padding-left:20px;color:#1e3a8a;font-size:14px;">
        <li>Identity-based Auth richiede SEMPRE due step: <strong>RBAC (Share Level)</strong> + <strong>NTFS (File
            Level)</strong>.</li>
        <li>Se usi le <strong>Storage Account Keys</strong>, diventi automaticamente SuperUser e bypassi i permessi
          NTFS.</li>
        <li>Per ambienti "Pure Cloud" senza Domain Controller, usa <strong>Azure AD Domain Services (AADDS)</strong>.
        </li>
        <li>Per ambienti ibridi, sincronizza l'AD on-prem con Azure AD Connect.</li>
      </ul>
    </div>
  </div>
</div>