<h2>Spostare Risorse Azure</h2>

<p>Azure permette di <strong>spostare risorse</strong> tra Resource Groups e Subscriptions per riorganizzare l'infrastruttura senza dover ricreare le risorse da zero.</p>

<!-- Diagramma Move Types -->
<svg viewBox="0 0 750 300" style="width:100%;max-width:750px;margin:1.5rem auto;display:block;">
  <defs>
    <linearGradient id="moveGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#6366f1"/>
      <stop offset="100%" style="stop-color:#8b5cf6"/>
    </linearGradient>
    <linearGradient id="subGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#22c55e"/>
      <stop offset="100%" style="stop-color:#16a34a"/>
    </linearGradient>
  </defs>

  <!-- Subscription 1 -->
  <rect x="30" y="30" width="300" height="240" rx="12" fill="#f8fafc" stroke="url(#moveGrad)" stroke-width="2"/>
  <text x="180" y="55" text-anchor="middle" font-size="12" font-weight="700" fill="#4f46e5">Subscription A</text>

  <!-- Source RG -->
  <rect x="50" y="75" width="120" height="90" rx="8" fill="#dbeafe"/>
  <text x="110" y="100" text-anchor="middle" font-size="10" font-weight="600" fill="#1e40af">Source RG</text>
  <rect x="60" y="115" width="40" height="30" rx="4" fill="#3b82f6"/>
  <text x="80" y="135" text-anchor="middle" font-size="8" fill="white">VM</text>
  <rect x="105" y="115" width="50" height="30" rx="4" fill="#3b82f6"/>
  <text x="130" y="135" text-anchor="middle" font-size="8" fill="white">Storage</text>

  <!-- Target RG (same sub) -->
  <rect x="190" y="75" width="120" height="90" rx="8" fill="#dcfce7"/>
  <text x="250" y="100" text-anchor="middle" font-size="10" font-weight="600" fill="#166534">Target RG</text>
  <text x="250" y="140" text-anchor="middle" font-size="9" fill="#64748b">(vuoto)</text>

  <!-- Move arrow within sub -->
  <path d="M170 120 L190 120" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="180" y="180" text-anchor="middle" font-size="9" fill="#22c55e" font-weight="600">Move tra RG</text>

  <!-- Subscription 2 -->
  <rect x="420" y="30" width="300" height="240" rx="12" fill="#f8fafc" stroke="url(#subGrad)" stroke-width="2"/>
  <text x="570" y="55" text-anchor="middle" font-size="12" font-weight="700" fill="#166534">Subscription B</text>

  <rect x="480" y="75" width="200" height="90" rx="8" fill="#dcfce7"/>
  <text x="580" y="100" text-anchor="middle" font-size="10" font-weight="600" fill="#166534">Target RG</text>
  <text x="580" y="140" text-anchor="middle" font-size="9" fill="#64748b">(stesso tenant)</text>

  <!-- Cross-sub arrow -->
  <path d="M310 120 L480 120" stroke="#6366f1" stroke-width="2" stroke-dasharray="8,4" marker-end="url(#arrowPurple)"/>
  <text x="395" y="110" text-anchor="middle" font-size="9" fill="#6366f1" font-weight="600">Move tra Subscription</text>

  <!-- Legend -->
  <rect x="50" y="200" width="80" height="25" rx="4" fill="#22c55e"/>
  <text x="90" y="217" text-anchor="middle" font-size="9" fill="white">Facile</text>

  <rect x="140" y="200" width="80" height="25" rx="4" fill="#6366f1"/>
  <text x="180" y="217" text-anchor="middle" font-size="9" fill="white">Pi√π complesso</text>

  <rect x="230" y="200" width="80" height="25" rx="4" fill="#ef4444"/>
  <text x="270" y="217" text-anchor="middle" font-size="9" fill="white">Tra Tenant</text>

  <text x="180" y="250" text-anchor="middle" font-size="10" fill="#64748b">Move tra tenant richiede transfer della subscription</text>

  <defs>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1"/>
    </marker>
  </defs>
</svg>

<h3>Tipi di Spostamento</h3>

<table style="width:100%;border-collapse:collapse;margin:1rem 0;font-size:0.9rem;">
  <thead>
    <tr style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;">
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Tipo Move</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Complessit√†</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Requisiti</th>
    </tr>
  </thead>
  <tbody>
    <tr style="background:#dcfce7;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Tra Resource Groups</td>
      <td style="padding:12px;border:1px solid #e2e8f0;color:#22c55e;">‚úì Semplice</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Write permission su source e destination RG</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Tra Subscriptions</td>
      <td style="padding:12px;border:1px solid #e2e8f0;color:#f59e0b;">‚ö†Ô∏è Media</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Stesso tenant, provider registrato, quote sufficienti</td>
    </tr>
    <tr style="background:#fef2f2;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Tra Tenant</td>
      <td style="padding:12px;border:1px solid #e2e8f0;color:#ef4444;">‚úó Complesso</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Richiede transfer della subscription intera</td>
    </tr>
  </tbody>
</table>

<h3>Prerequisiti per lo Spostamento</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin:1.5rem 0;">
  <div style="background:#f8fafc;padding:1.25rem;border-radius:8px;border-left:4px solid #3b82f6;">
    <h4 style="margin:0 0 0.75rem 0;color:#1e40af;">üìã Permessi Richiesti</h4>
    <ul style="margin:0;padding-left:1.25rem;font-size:0.875rem;color:#64748b;">
      <li><strong>Write permission</strong> su source RG</li>
      <li><strong>Write permission</strong> su destination RG</li>
      <li><strong>Write permission</strong> sulle risorse da spostare</li>
      <li>Per cross-sub: write su entrambe le subscription</li>
    </ul>
  </div>
  <div style="background:#f8fafc;padding:1.25rem;border-radius:8px;border-left:4px solid #22c55e;">
    <h4 style="margin:0 0 0.75rem 0;color:#166534;">‚úì Condizioni</h4>
    <ul style="margin:0;padding-left:1.25rem;font-size:0.875rem;color:#64748b;">
      <li>Nessun <strong>Resource Lock</strong> attivo</li>
      <li>Resource provider <strong>registrato</strong> in destination</li>
      <li><strong>Quote sufficienti</strong> nella destination</li>
      <li>Entrambe le subscription <strong>attive</strong></li>
    </ul>
  </div>
</div>

<h3>Cosa Succede Durante il Move</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin:1.5rem 0;">
  <div style="background:linear-gradient(135deg,#fef3c7,#fffbeb);padding:1rem;border-radius:8px;border-left:4px solid #f59e0b;">
    <strong style="color:#b45309;">üîí Lock Temporaneo</strong>
    <p style="font-size:0.875rem;margin-top:0.5rem;color:#334155;">Source e destination sono bloccati per operazioni di scrittura durante il move</p>
  </div>
  <div style="background:linear-gradient(135deg,#dcfce7,#f0fdf4);padding:1rem;border-radius:8px;border-left:4px solid #22c55e;">
    <strong style="color:#166534;">‚úì Disponibilit√†</strong>
    <p style="font-size:0.875rem;margin-top:0.5rem;color:#334155;">Le risorse restano <strong>disponibili</strong> - le app continuano a funzionare</p>
  </div>
  <div style="background:linear-gradient(135deg,#dbeafe,#eff6ff);padding:1rem;border-radius:8px;border-left:4px solid #3b82f6;">
    <strong style="color:#1e40af;">üè∑Ô∏è Tag Mantenuti</strong>
    <p style="font-size:0.875rem;margin-top:0.5rem;color:#334155;">I tag delle risorse vengono preservati durante lo spostamento</p>
  </div>
  <div style="background:linear-gradient(135deg,#fef2f2,#fff5f5);padding:1rem;border-radius:8px;border-left:4px solid #ef4444;">
    <strong style="color:#dc2626;">‚ö†Ô∏è ID Cambia</strong>
    <p style="font-size:0.875rem;margin-top:0.5rem;color:#334155;">Il <strong>Resource ID cambia</strong> - aggiorna script e automazioni!</p>
  </div>
</div>

<div style="background:linear-gradient(135deg,#fef3c7,#fffbeb);padding:1rem;border-radius:8px;margin:1rem 0;border-left:4px solid #f59e0b;">
  <strong style="color:#b45309;">‚ö†Ô∏è Importante:</strong>
  <span style="color:#92400e;font-size:0.9rem;"> I <strong>Role Assignments NON vengono spostati</strong>. Devi ricrearli manualmente nel destination!</span>
</div>

<h3>Risorse con Limitazioni di Spostamento</h3>

<p>Alcune risorse <strong>non possono essere spostate</strong> o hanno limitazioni specifiche:</p>

<table style="width:100%;border-collapse:collapse;margin:1rem 0;font-size:0.85rem;">
  <thead>
    <tr style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;">
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Resource Type</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Limitazione</th>
    </tr>
  </thead>
  <tbody>
    <tr style="background:#fef2f2;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Microsoft Entra ID Domain Services</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Non pu√≤ essere spostato</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Recovery Services Vault</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Non con backup attivi (devi eliminare i backup)</td>
    </tr>
    <tr style="background:#fef2f2;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Classic VMs / VNets</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Risorse Classic non supportano il move</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">App Service (con custom domain)</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Limitazioni con certificati e domini custom</td>
    </tr>
    <tr style="background:#fef2f2;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Azure DevOps Organization</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Non pu√≤ essere spostata</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Managed Disks (some configs)</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Limitazioni con alcune configurazioni di encryption</td>
    </tr>
    <tr style="background:#fef2f2;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Virtual Network con peering</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Devi rimuovere il peering prima del move</td>
    </tr>
  </tbody>
</table>

<p style="font-size:0.9rem;color:#64748b;">Consulta sempre la <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/move-support-resources" target="_blank" style="color:#3b82f6;">documentazione Microsoft</a> per l'elenco aggiornato.</p>

<h3>Dipendenze e Risorse Collegate</h3>

<p>Alcune risorse <strong>devono essere spostate insieme</strong>:</p>

<table style="width:100%;border-collapse:collapse;margin:1rem 0;font-size:0.9rem;">
  <thead>
    <tr style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;">
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Risorsa Principale</th>
      <th style="padding:12px;text-align:left;border:1px solid #e2e8f0;">Risorse Dipendenti</th>
    </tr>
  </thead>
  <tbody>
    <tr style="background:#f8fafc;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Virtual Machine</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">OS Disk, Data Disks, NICs (tutti insieme)</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Virtual Network</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Subnets (incluse automaticamente)</td>
    </tr>
    <tr style="background:#f8fafc;">
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">Storage Account</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Containers, Blobs, File Shares (inclusi)</td>
    </tr>
    <tr>
      <td style="padding:12px;border:1px solid #e2e8f0;font-weight:600;">SQL Server</td>
      <td style="padding:12px;border:1px solid #e2e8f0;">Database (tutti insieme)</td>
    </tr>
  </tbody>
</table>

<h3>Validare Prima di Spostare</h3>

<p><strong>Raccomandazione</strong>: Valida sempre la possibilit√† di spostamento prima di eseguirlo:</p>

<pre style="background:#1e293b;color:#e2e8f0;padding:1.25rem;border-radius:8px;overflow-x:auto;font-size:0.875rem;"><code><span style="color:#94a3b8;"># Validare il move (API/REST call)</span>
az rest --method POST \
  --uri "https://management.azure.com/subscriptions/{sub-id}/resourceGroups/{source-rg}/validateMoveResources?api-version=2021-04-01" \
  --body '{
    "resources": [
      "/subscriptions/{sub-id}/resourceGroups/{source-rg}/providers/Microsoft.Storage/storageAccounts/mystorage"
    ],
    "targetResourceGroup": "/subscriptions/{sub-id}/resourceGroups/{target-rg}"
  }'

<span style="color:#94a3b8;"># Il risultato sar√† 202 Accepted con Location header per verificare lo stato</span></code></pre>

<h3>Spostare Risorse con Azure CLI</h3>

<pre style="background:#1e293b;color:#e2e8f0;padding:1.25rem;border-radius:8px;overflow-x:auto;font-size:0.875rem;"><code><span style="color:#94a3b8;"># Spostare una risorsa tra Resource Groups (stessa subscription)</span>
az resource move \
  --destination-group "target-rg" \
  --ids "/subscriptions/{sub-id}/resourceGroups/source-rg/providers/Microsoft.Storage/storageAccounts/mystorage"

<span style="color:#94a3b8;"># Spostare multiple risorse</span>
az resource move \
  --destination-group "target-rg" \
  --ids "/subscriptions/{sub-id}/resourceGroups/source-rg/providers/Microsoft.Compute/virtualMachines/myvm" \
        "/subscriptions/{sub-id}/resourceGroups/source-rg/providers/Microsoft.Network/networkInterfaces/myvm-nic"

<span style="color:#94a3b8;"># Spostare tra Subscriptions</span>
az resource move \
  --destination-subscription-id "{target-sub-id}" \
  --destination-group "target-rg" \
  --ids "/subscriptions/{source-sub-id}/resourceGroups/source-rg/providers/Microsoft.Storage/storageAccounts/mystorage"

<span style="color:#94a3b8;"># Verificare lo stato delle risorse dopo il move</span>
az resource list --resource-group "target-rg" --output table</code></pre>

<h3>Spostare Risorse con PowerShell</h3>

<pre style="background:#1e293b;color:#e2e8f0;padding:1.25rem;border-radius:8px;overflow-x:auto;font-size:0.875rem;"><code><span style="color:#94a3b8;"># Get resource to move</span>
$resource = Get-AzResource `
  -ResourceGroupName "source-rg" `
  -ResourceName "mystorage" `
  -ResourceType "Microsoft.Storage/storageAccounts"

<span style="color:#94a3b8;"># Move to another resource group (same subscription)</span>
Move-AzResource `
  -DestinationResourceGroupName "target-rg" `
  -ResourceId $resource.ResourceId

<span style="color:#94a3b8;"># Move multiple resources</span>
$resources = Get-AzResource -ResourceGroupName "source-rg"
$resourceIds = $resources | ForEach-Object { $_.ResourceId }

Move-AzResource `
  -DestinationResourceGroupName "target-rg" `
  -ResourceId $resourceIds

<span style="color:#94a3b8;"># Move to another subscription</span>
Move-AzResource `
  -DestinationSubscriptionId "{target-sub-id}" `
  -DestinationResourceGroupName "target-rg" `
  -ResourceId $resource.ResourceId

<span style="color:#94a3b8;"># Verify move</span>
Get-AzResource -ResourceGroupName "target-rg" | Format-Table Name, ResourceType</code></pre>

<h3>Post-Move Checklist</h3>

<div style="background:#f8fafc;padding:1.25rem;border-radius:8px;border:1px solid #e2e8f0;margin:1rem 0;">
  <h4 style="margin:0 0 1rem 0;color:#334155;">‚úÖ Dopo lo spostamento, verifica:</h4>
  <ul style="margin:0;padding-left:1.25rem;font-size:0.9rem;color:#64748b;">
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Aggiorna i Resource ID</strong> negli script e nelle automazioni</li>
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Ricrea i Role Assignments</strong> nel destination</li>
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Verifica le diagnostics settings</strong> e i log destinations</li>
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Testa le applicazioni</strong> che dipendono dalle risorse</li>
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Aggiorna i budget</strong> e gli alert di Cost Management</li>
    <li><input type="checkbox" disabled style="margin-right:0.5rem;"><strong>Verifica le Azure Policy</strong> nel nuovo scope</li>
  </ul>
</div>

<h3>Best Practices per il Move</h3>

<ul>
  <li><strong>Valida sempre prima di spostare</strong>: Usa validateMoveResources API</li>
  <li><strong>Pianifica in orari di basso traffico</strong>: Anche se le risorse restano disponibili, ci sono lock temporanei</li>
  <li><strong>Documenta i nuovi Resource ID</strong>: Aggiorna tutti i riferimenti</li>
  <li><strong>Ricrea i Role Assignments</strong>: Non vengono spostati automaticamente</li>
  <li><strong>Testa dopo il move</strong>: Verifica che tutto funzioni correttamente</li>
  <li><strong>Considera le dipendenze</strong>: Sposta insieme le risorse correlate</li>
</ul>

<div style="background:linear-gradient(135deg,#dbeafe,#eff6ff);padding:1.25rem;border-radius:8px;margin:1.5rem 0;border-left:4px solid #3b82f6;">
  <h4 style="margin:0 0 0.75rem 0;color:#1e40af;">üí° Tip per l'Esame AZ-104</h4>
  <ul style="margin:0;padding-left:1.25rem;font-size:0.9rem;color:#1e40af;">
    <li>Le risorse <strong>restano disponibili</strong> durante il move</li>
    <li>Il <strong>Resource ID cambia</strong> dopo lo spostamento - aggiorna script!</li>
    <li>I <strong>Role Assignments NON vengono spostati</strong> - devi ricrearli</li>
    <li>I <strong>Lock devono essere rimossi</strong> prima del move</li>
    <li>Per cross-subscription: stesso <strong>tenant</strong>, <strong>provider registrato</strong>, <strong>quote sufficienti</strong></li>
    <li>Usa <code>az resource move</code> per CLI, <code>Move-AzResource</code> per PowerShell</li>
  </ul>
</div>
